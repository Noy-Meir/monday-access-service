# =============================================================================
# monday-access-service — GraphQL API Tests
# WebStorm REST Client (.http)
#
# HOW TO USE:
#   1. Start the server:  npm run dev
#   2. Run requests top-to-bottom — login steps must run first to capture tokens.
#   3. After "Create Access Request", copy the returned `id` into @request_id.
#
# SEEDED USERS:
#   alice@company.com  / Password123!  → EMPLOYEE
#   bob@company.com    / Password123!  → EMPLOYEE
#   carol@company.com  / Password123!  → IT
#   dave@company.com   / Password123!  → HR
#   eve@company.com    / Password123!  → MANAGER
#   frank@company.com  / Password123!  → ADMIN
#
# ENDPOINT: POST http://localhost:3000/graphql  (all operations)
# =============================================================================

@graphqlUrl = http://localhost:3000/graphql

# Paste IDs here after running the create steps
@request_id       = replace-me-with-real-id
@multi_request_id = replace-me-with-real-id


# =============================================================================
# HEALTH CHECK
# =============================================================================

### Sanity-check that the server is up. No auth required.
# Expected: 200 { "status": "ok", "timestamp": "..." }
GET http://localhost:3000/health


# =============================================================================
# EMPLOYEE WORKFLOW
# =============================================================================

### [1] Login as Employee (alice)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "EMPLOYEE" } } } }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email name role } } }",
  "variables": { "email": "alice@company.com", "password": "Password123!" }
}

> {%
  client.global.set("auth_token", response.body.data.login.token);
  client.log("Employee token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

###

### [2] Create Access Request — GitHub (tech, needs IT)
# Expected: { "data": { "createRequest": { "id": "...", "status": "PENDING", "requiredApprovals": ["IT"] } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation CreateRequest($app: String!, $just: String!) { createRequest(applicationName: $app, justification: $just) { id applicationName status requiredApprovals createdByEmail createdAt } }",
  "variables": {
    "app": "GitHub",
    "just": "Need access to manage code repositories for the upcoming Q3 development sprint."
  }
}

> {%
  client.global.set("request_id", response.body.data.createRequest.id);
  client.log("Request ID captured: " + response.body.data.createRequest.id);
%}

###

### [3] Get My Requests (Employee — own requests only)
# Expected: { "data": { "myRequests": [ ... ] } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "query MyRequests($userId: ID!) { myRequests(userId: $userId) { id applicationName status requiredApprovals approvals { role approvedByEmail approvedAt } createdAt } }",
  "variables": { "userId": "user-alice-001" }
}

###


# =============================================================================
# IT APPROVER WORKFLOW
# =============================================================================

### [4] IT Login (carol)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "IT" } } } }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email name role } } }",
  "variables": { "email": "carol@company.com", "password": "Password123!" }
}

> {%
  client.global.set("it_token", response.body.data.login.token);
  client.log("IT token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

###

### [4b] HR Login (dave)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "HR" } } } }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email name role } } }",
  "variables": { "email": "dave@company.com", "password": "Password123!" }
}

> {%
  client.global.set("hr_token", response.body.data.login.token);
  client.log("HR token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

###

### [4c] Manager Login (eve)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "MANAGER" } } } }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email name role } } }",
  "variables": { "email": "eve@company.com", "password": "Password123!" }
}

> {%
  client.global.set("manager_token", response.body.data.login.token);
  client.log("Manager token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

###

### [4d] Admin Login (frank)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "ADMIN" } } } }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email name role } } }",
  "variables": { "email": "frank@company.com", "password": "Password123!" }
}

> {%
  client.global.set("admin_token", response.body.data.login.token);
  client.log("Admin token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

###

### [5] Get ALL Requests (IT — non-employee role)
# Expected: { "data": { "allRequests": [ ... all requests ... ] } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query { allRequests { id applicationName status requiredApprovals approvals { role approvedByEmail } createdByEmail createdAt } }"
}

###

### [6] Filter Requests by Status — PENDING
# Expected: { "data": { "requestsByStatus": [ ... only PENDING ... ] } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query ByStatus($status: RequestStatus!) { requestsByStatus(status: $status) { id applicationName status } }",
  "variables": { "status": "PENDING" }
}

###

### [7] Filter Requests by Status — PARTIALLY_APPROVED
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query ByStatus($status: RequestStatus!) { requestsByStatus(status: $status) { id applicationName status approvals { role } } }",
  "variables": { "status": "PARTIALLY_APPROVED" }
}

###

### [8] Filter Requests by Status — APPROVED
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query ByStatus($status: RequestStatus!) { requestsByStatus(status: $status) { id applicationName status } }",
  "variables": { "status": "APPROVED" }
}

###

### [9] View alice's requests as IT (cross-user lookup)
# Expected: { "data": { "myRequests": [ ... alice's requests ... ] } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query MyRequests($userId: ID!) { myRequests(userId: $userId) { id applicationName status } }",
  "variables": { "userId": "user-alice-001" }
}

###

### [10] APPROVE GitHub request (IT — single approval → APPROVED immediately)
# Expected: { "data": { "decideRequest": { "status": "APPROVED", "decisionByEmail": "carol@company.com" } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!, $note: String) { decideRequest(id: $id, decision: $decision, decisionNote: $note) { id status decisionBy decisionByEmail decisionNote decisionAt } }",
  "variables": {
    "id": "{{request_id}}",
    "decision": "APPROVED",
    "note": "Approved after verifying business justification and completing security review."
  }
}

###

### [11] DENY a Request (any authorized role)
# First create a new request (re-run step [2]) and update @request_id.
# Expected: { "data": { "decideRequest": { "status": "DENIED" } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!, $note: String) { decideRequest(id: $id, decision: $decision, decisionNote: $note) { id status decisionByEmail decisionNote } }",
  "variables": {
    "id": "{{request_id}}",
    "decision": "DENIED",
    "note": "Insufficient justification. Please provide a specific business case and re-submit."
  }
}


# =============================================================================
# MULTI-APPROVAL WORKFLOW (Database Access — needs MANAGER + IT)
# =============================================================================

### [MA-1] Create a Database Access request (requires MANAGER + IT)
# Expected: { "data": { "createRequest": { "requiredApprovals": ["MANAGER","IT"], "status": "PENDING" } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation CreateRequest($app: String!, $just: String!) { createRequest(applicationName: $app, justification: $just) { id applicationName status requiredApprovals } }",
  "variables": {
    "app": "Database Access",
    "just": "Need read-only access to investigate a customer-reported data discrepancy in the orders table."
  }
}

> {%
  client.global.set("multi_request_id", response.body.data.createRequest.id);
  client.log("Multi-approval request ID: " + response.body.data.createRequest.id);
%}

###

### [MA-2] MANAGER approves → expect PARTIALLY_APPROVED
# Expected: { "data": { "decideRequest": { "status": "PARTIALLY_APPROVED", "approvals": [{"role":"MANAGER"}] } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!, $note: String) { decideRequest(id: $id, decision: $decision, decisionNote: $note) { id status approvals { role approvedByEmail approvedAt } } }",
  "variables": {
    "id": "{{multi_request_id}}",
    "decision": "APPROVED",
    "note": "Manager sign-off granted."
  }
}

###

### [MA-3] IT approves → expect APPROVED (all required roles covered)
# Expected: { "data": { "decideRequest": { "status": "APPROVED", "approvals": [{"role":"MANAGER"},{"role":"IT"}] } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!, $note: String) { decideRequest(id: $id, decision: $decision, decisionNote: $note) { id status approvals { role approvedByEmail approvedAt } } }",
  "variables": {
    "id": "{{multi_request_id}}",
    "decision": "APPROVED",
    "note": "IT sign-off granted."
  }
}


# =============================================================================
# ROLE BOUNDARY TESTS
# =============================================================================

### [RB-1] Create HiBob request (HR-only)
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation CreateRequest($app: String!, $just: String!) { createRequest(applicationName: $app, justification: $just) { id applicationName requiredApprovals } }",
  "variables": {
    "app": "HiBob",
    "just": "Need access to update employee records for the new onboarding cohort."
  }
}

> {%
  client.global.set("hibob_request_id", response.body.data.createRequest.id);
%}

###

### [RB-2] IT tries to approve an HR-only request → expect 403
# Expected: { "errors": [{ "message": "Role 'IT' is not authorized..." }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!) { decideRequest(id: $id, decision: $decision) { id status } }",
  "variables": { "id": "{{hibob_request_id}}", "decision": "APPROVED" }
}

###

### [RB-3] Create GitHub request (IT-only)
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation CreateRequest($app: String!, $just: String!) { createRequest(applicationName: $app, justification: $just) { id applicationName requiredApprovals } }",
  "variables": {
    "app": "GitHub",
    "just": "Need access to manage code repositories for the new feature branch workflow."
  }
}

> {%
  client.global.set("github_request_id", response.body.data.createRequest.id);
%}

###

### [RB-4] HR tries to approve a tech (GitHub) request → expect 403
# Expected: { "errors": [{ "message": "Role 'HR' is not authorized..." }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{hr_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!) { decideRequest(id: $id, decision: $decision) { id status } }",
  "variables": { "id": "{{github_request_id}}", "decision": "APPROVED" }
}


# =============================================================================
# AI RISK ASSESSMENT
# =============================================================================

### [AI-1] Assess risk on a request as the owner (Employee)
# Runs AI risk assessment and persists the result on the request.
# Expected: { "data": { "assessRequestRisk": { "score": ..., "riskLevel": "LOW"|"MEDIUM"|"HIGH"|"CRITICAL", "reasoning": "..." } } }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation AssessRequestRisk($requestId: ID!) { assessRequestRisk(requestId: $requestId) { requestId score riskLevel reasoning assessedAt metrics { executionTimeMs provider tokensUsed modelId } } }",
  "variables": { "requestId": "{{request_id}}" }
}

###

### [AI-2] Assess risk as an approver (IT — can assess any request)
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation AssessRequestRisk($requestId: ID!) { assessRequestRisk(requestId: $requestId) { requestId score riskLevel reasoning assessedAt metrics { executionTimeMs provider } } }",
  "variables": { "requestId": "{{request_id}}" }
}

###

### [AI-3] Confirm aiAssessment is persisted — query allRequests and check aiAssessment field
# After running AI-1 or AI-2, the result should appear under aiAssessment on the request.
# Expected: allRequests[n].aiAssessment.score is populated
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "query { allRequests { id applicationName status aiAssessment { score riskLevel reasoning assessedAt } } }"
}

###

### [AI-4] FORBIDDEN — Employee cannot assess another user's request
# Expected: { "errors": [{ "extensions": { "code": "FORBIDDEN" } }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation AssessRequestRisk($requestId: ID!) { assessRequestRisk(requestId: $requestId) { requestId score } }",
  "variables": { "requestId": "req-approved-002" }
}

###

# =============================================================================
# ERROR & EDGE CASES
# =============================================================================

### [E1] UNAUTHENTICATED — No token provided
# Expected: { "errors": [{ "extensions": { "code": "UNAUTHENTICATED" } }] }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation CreateRequest($app: String!, $just: String!) { createRequest(applicationName: $app, justification: $just) { id } }",
  "variables": { "app": "GitHub", "just": "Need access to push code." }
}

###

### [E2] UNAUTHENTICATED — Invalid / malformed token
# Expected: { "errors": [{ "extensions": { "code": "UNAUTHENTICATED" } }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer this.is.not.a.valid.token

{
  "query": "query { allRequests { id } }"
}

###

### [E3] Wrong password at login
# Expected: { "errors": [{ "message": "Invalid credentials" }] }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token } }",
  "variables": { "email": "alice@company.com", "password": "WrongPassword!" }
}

###

### [E4] Unknown email (same message as wrong password — anti-enumeration)
# Expected: { "errors": [{ "message": "Invalid credentials" }] }
POST {{graphqlUrl}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token } }",
  "variables": { "email": "ghost@company.com", "password": "Password123!" }
}

###

### [E5] FORBIDDEN — Employee attempts to approve a request
# Expected: { "errors": [{ "message": "Access denied: role 'EMPLOYEE' does not have permission..." }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!) { decideRequest(id: $id, decision: $decision) { id } }",
  "variables": { "id": "{{request_id}}", "decision": "APPROVED" }
}

###

### [E6] FORBIDDEN — Employee attempts to list all requests
# Expected: { "errors": [{ "message": "Access denied: role 'EMPLOYEE' does not have permission..." }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "query { allRequests { id } }"
}

###

### [E7] FORBIDDEN — Employee attempts to view another user's requests
# Expected: { "errors": [{ "message": "You can only view your own access requests" }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "query MyRequests($userId: ID!) { myRequests(userId: $userId) { id } }",
  "variables": { "userId": "user-bob-002" }
}

###

### [E8] NOT FOUND — Request ID does not exist
# Expected: { "errors": [{ "message": "Access request 'non-existent-id' not found" }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!) { decideRequest(id: $id, decision: $decision) { id } }",
  "variables": { "id": "non-existent-id", "decision": "APPROVED" }
}

###

### [E9] CONFLICT — Attempting to decide on an already-decided request
# Run step [10] first to approve, then run this.
# Expected: { "errors": [{ "message": "Cannot decide on a request with status 'APPROVED'..." }] }
POST {{graphqlUrl}}
Content-Type: application/json
Authorization: Bearer {{it_token}}

{
  "query": "mutation Decide($id: ID!, $decision: RequestStatus!) { decideRequest(id: $id, decision: $decision) { id } }",
  "variables": { "id": "{{request_id}}", "decision": "DENIED" }
}

###

### [E10] NOT FOUND — Unknown route (REST 404 still works)
# Expected: 404 { "error": { "message": "Route not found" } }
GET http://localhost:3000/api/does-not-exist
Authorization: Bearer {{auth_token}}
