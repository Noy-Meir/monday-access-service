# =============================================================================
# monday-access-service — AI Risk Assessment GraphQL Tests
# WebStorm REST Client (.http)
#
# HOW TO USE:
#   1. Start the server:  npm run dev
#   2. Run [1] Employee Login and [2] IT Approver Login first to capture tokens.
#   3. Run [3] Create requests — IDs are auto-captured into global variables.
#   4. Run risk assessment queries against those IDs.
#
# SEEDED USERS:
#   alice@company.com  / Password123!  → EMPLOYEE
#   carol@company.com  / Password123!  → IT (approver)
#
# ENV VARIABLES (toggle the AI provider):
#   Default (mock):   npm run dev
#   Real Claude:      AI_PROVIDER=claude ANTHROPIC_API_KEY=sk-ant-... npm run dev
# =============================================================================

@baseUrl = http://localhost:3000
@graphql = {{baseUrl}}/graphql


# [1] LOGIN — EMPLOYEE


### Login as Employee (alice)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "EMPLOYEE", ... } } } }
POST {{graphql}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email role } } }",
  "variables": {
    "email": "alice@company.com",
    "password": "Password123!"
  }
}

> {%
  client.global.set("auth_token", response.body.data.login.token);
  client.log("Employee token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}


# =============================================================================
# [2] LOGIN — IT APPROVER
# =============================================================================

### Login as IT Approver (carol)
# Expected: { "data": { "login": { "token": "...", "user": { "role": "IT", ... } } } }
POST {{graphql}}
Content-Type: application/json

{
  "query": "mutation Login($email: String!, $password: String!) { login(email: $email, password: $password) { token user { id email role } } }",
  "variables": {
    "email": "carol@company.com",
    "password": "Password123!"
  }
}

> {%
  client.global.set("admin_token", response.body.data.login.token);
  client.log("IT Approver token captured: " + response.body.data.login.token.substring(0, 20) + "...");
%}

# [3] CREATE REQUESTS

### [3a] Create LOW-risk request (Employee)

POST {{graphql}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation CreateRequest($applicationName: String!, $justification: String!) { createRequest(applicationName: $applicationName, justification: $justification) { id applicationName justification status requiredApprovals createdAt } }",
  "variables": {
    "applicationName": "Slack",
    "justification": "Need access to collaborate with my team on the Q3 project planning and daily standups."
  }
}

> {%
  client.global.set("low_risk_request_id", response.body.data.createRequest.id);
  client.log("Low-risk request ID: " + response.body.data.createRequest.id);
%}


# [4] RISK ASSESSMENT — EMPLOYEE (own request)

### [4a] Assess LOW-risk request as Employee
# Employee assesses their own Slack request.
# Expected: { "data": { "assessRequestRisk": { "score": 8, "riskLevel": "LOW", "reasoning": "...", "metrics": { ... } } } }
POST {{graphql}}
Content-Type: application/json
Authorization: Bearer {{auth_token}}

{
  "query": "mutation AssessRequestRisk($requestId: ID!) { assessRequestRisk(requestId: $requestId) { requestId score riskLevel reasoning assessedAt metrics { executionTimeMs provider tokensUsed modelId } } }",
  "variables": {
    "requestId": "{{low_risk_request_id}}"
  }
}
